{% extends "base.html" %}
{% block body %}
  <h2>Login</h2>
  <form id='login-form'>
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Login</button>
  </form>
  <p><a href="{% url 'register_view' %}">Register</a> if you don't have an account.</p>

  <script>
    // handle form submission via AJAX
    document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('login-form');
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        const username = form.querySelector('input[name="username"]').value;
        const password = form.querySelector('input[name="password"]').value;
        fetch("{% url 'login_api' %}", {
            method: 'POST',
            body: JSON.stringify({ username, password }),
            headers: {
                "Content-Type": "application/json"
            }
        })
        .then(response => {
            if ( response.status === 200 ) {
                return response.json();
            } else if ( response.status === 401 ) {
                // Try to refresh token
                const refreshToken = localStorage.getItem('refresh');
                return fetch("{% url 'token_refresh' %}", {
                    method: 'POST',
                    body: JSON.stringify({ refresh: refreshToken }),
                    headers: {
                        "Content-Type": "application/json"
                    }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.access) {
                        localStorage.setItem('access', data.access);
                        return data;
                    } else {
                        throw new Error('Unable to refresh token.');
                    }
                })
            }
        })
        .then(data => {
            if (data.success) {
                alert ("Login successful!");
                localStorage.setItem("access", data.access);
                localStorage.setItem("refresh", data.refresh);
                window.location.href = '{% url "index" %}';
            } else {
                // Handle errors
                alert('Error during login: ' + data.errors.join(', '));
            }
        });
    });
});
  </script>
{% endblock %}